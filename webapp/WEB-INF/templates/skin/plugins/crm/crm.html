<#-- Build the url resource from a given demand_type -->
<#function buildDemandTypeUrlResource demand_type user>
	<#if demand_type??>
		<#if ( demand_type.urlResource?index_of( "?" ) >= 0 )>
			<#return demand_type.urlResource + "&amp;id_demand_type=" + demand_type.idDemandType + "&amp;user_guid=" + user.name>
		<#else>
			<#return demand_type.urlResource + "?id_demand_type=" + demand_type.idDemandType + "&amp;user_guid=" + user.name>
		</#if>
	</#if>
	<#return "">
</#function>

<#-- Get the label of the demand type from a given id demand type -->
<#function getDemandTypeLabel demand_types_list id_demand_type>
	<#list demand_types_list as demand_type>
		<#if demand_type.idDemandType = id_demand_type>
			<#return demand_type.label>
		</#if>
	</#list>
	<#return "">
</#function>

<#-- Get the url resource from a given id demand type -->
<#function getDemandTypeUrlResource demand_types_list demand>
	<#if demand?? && demand_types_list??>
		<#list demand_types_list as demand_type>
			<#if demand_type.idDemandType = demand.idDemandType>
				<#return demand_type.urlResource>
			</#if>
		</#list>
	</#if>
	<#return "">
</#function>

<div class="span-11 prepend-1 append-1">
	<div class="portlet-background append-bottom">
		<div class="portlet-background-header -lutece-border-radius-top">
			#i18n{crm.crm.labelDemandsList}
		</div>
		<div class="portlet-background-content -lutece-border-radius-bottom">
			<#list status_crm_list as status_crm>
				<#assign demands_list = map_demands_list[""+status_crm.idStatusCRM]>
				<#if demands_list?has_content>
					<fieldset>
						<legend>${status_crm.label}</legend>
						<table>
							<#list demands_list as demand>
								<tr>
									<td>
										<form method="post" action="${getDemandTypeUrlResource( demand_types_list, demand )}">
											<input type="hidden" name="id_demand" value="${demand.idDemand}" />
											<input type="hidden" name="demand_data" value="${demand.data}" />
											<input type="submit" value="${getDemandTypeLabel( demand_types_list, demand.idDemandType)}" />
										</form>
									</td>
									<td>
										${demand.statusText}
									</td>
									<td>
										<#if ( demand.getNumberNotifications(  ) > 0 )>
											<a href="jsp/site/Portal.jsp?page=crm&amp;action=manage_notifications&amp;id_demand=${demand.idDemand}">
												<img src="images/local/skin/plugins/crm/mail.png" alt="#i18n{crm.crm.labelMail}" title="#i18n{crm.crm.labelMail}" />
											</a>
											<#if ( demand.getNumberUnreadNotifications(  ) > 0 )>
												<span class="alert">
													${demand.numberUnreadNotifications}
												</span>
											</#if>
										</#if> 
									</td>
									<#if demand.idStatusCRM = 0>
										<td>
											<a href="jsp/site/Portal.jsp?page=crm&amp;action=remove_demand&amp;id_demand=${demand.idDemand}">
												<img src="images/local/skin/plugins/crm/actions/delete.png" alt="#i18n{crm.crm.buttonDelete}" title="#i18n{crm.crm.buttonDelete}" />
											</a>
										</td>
									</#if>
								</tr>
							</#list>
						</table>
					</fieldset>
				</#if>
			</#list>
		</div>
	</div>
</div>

<#if categories_list?has_content>
	<div class="span-10 append-1 last">
		<div class="portlet-background append-bottom">
			<div class="portlet-background-header -lutece-border-radius-top">
				#i18n{crm.crm.labelDemandTypesList}
			</div>
			<div class="portlet-background-content -lutece-border-radius">
				<#list categories_list as category>
					<#assign demand_types = map_demand_types_list[category.code]>
					<#if demand_types?has_content>
						<fieldset>
							<#-- No category -->
							<#if category.code != "0">
								<legend>${category.name}</legend>
							</#if>
							<ul>
								<#list demand_types as demand_type>
									<li>
										<a href="${buildDemandTypeUrlResource( demand_type, mylutece_user )}">
											${demand_type.label}
										</a>
										<#if demand_type.urlInfo?has_content>
											<br />
											<em>
												<a href="${demand_type.urlInfo}">
													#i18n{crm.crm.labelInfo}
												</a>
											</em>
										</#if>
										<#if demand_type.urlContact?has_content>
											<br />
											<em>
												<a href="${demand_type.urlContact}">
													#i18n{crm.crm.labelContact}
												</a>
											</em>
										</#if>
										<#if demand_type.dateBegin??>
											<br />
											#i18n{crm.crm.labelDateBegin} : ${demand_type.dateBegin?date}
										</#if>
										<#if demand_type.dateEnd??>
											<br />
											#i18n{crm.crm.labelDateEnd} : ${demand_type.dateEnd?date}
										</#if>
									</li>
								</#list>
							</ul>
						</fieldset>
					</#if>
				</#list>
			</div>
		</div>
	</div>
</#if>
